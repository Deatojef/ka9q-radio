<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KA9Q-Radio: Some useful notes on networking for &#39;ka9q-radio&#39;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">KA9Q-Radio
   </div>
   <div id="projectbrief">KA9Q multichannel SDR packagea</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Some useful notes on networking for 'ka9q-radio'</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> By default multicast packets are sent and received over the primary interface, which is typically the wired network or the wireless network. To see which interface is the primary one, run: </p><div class="fragment"><div class="line">ip address show</div>
</div><!-- fragment --><p> and look for the first interface marked 'MULTICAST', 'UP', and 'LOWER_UP'</p>
<p>For a full local setup where both 'radiod' and the client applications ('monitor', 'control', 'pcmcat', etc) are on the same host, the loopback ('lo') interface can be used instead as documented in the second part of the document.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Using the primary interface for multicasting</h1>
<p>This is the default configuration with 'ka9q-radio'; the important task in this case is to create firewall rules for the RTP streams (data) and for the control application</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Firewall rule for RTP streams</h2>
<p>The RTP streams (sound/IQ data) use port 5004/udp; for client applications like 'monitor' and 'pcmcat' to work, port 5004/udp needs to be open: </p><div class="fragment"><div class="line">firewall-cmd --add-port=5004/udp --permanent</div>
<div class="line">firewall-cmd --reload</div>
</div><!-- fragment --><p>The 'monitor' client application can then be used to listen to the RTP streams; for instance: </p><div class="fragment"><div class="line">monitor nws-pcm.local</div>
</div><!-- fragment --><p>A tighter firewall rule allowing only multicast addresses in the 239.0.0.0/8 network can be defined (instead of the one above) using firewalld 'rich rules': </p><div class="fragment"><div class="line">firewall-cmd --add-rich-rule=&#39;rule family=&quot;ipv4&quot; destination address=&quot;239.0.0.0/8&quot; port port=&quot;5004&quot; protocol=&quot;udp&quot; accept&#39; --permanent</div>
<div class="line">firewall-cmd --reload</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3"></a>
Firewall rule for control connection</h2>
<p>The control connection instead uses port 5006/udp; for client applications like 'control' to work, port 5006/udp needs to be open: </p><div class="fragment"><div class="line">firewall-cmd --add-port=5006/udp --permanent</div>
<div class="line">firewall-cmd --reload</div>
</div><!-- fragment --><p>The 'control' client application can then be used to send control commands to a specific channel in 'radiod' identified by its SSRC; for instance: </p><div class="fragment"><div class="line">control -s 162550 nws.local</div>
</div><!-- fragment --><p>A tighter firewall rule allowing only multicast addresses in the 239.0.0.0/8 network can be defined (instead of the one above) using firewalld 'rich rules': </p><div class="fragment"><div class="line">firewall-cmd --add-rich-rule=&#39;rule family=&quot;ipv4&quot; destination address=&quot;239.0.0.0/8&quot; port port=&quot;5006&quot; protocol=&quot;udp&quot; accept&#39; --permanent</div>
<div class="line">firewall-cmd --reload</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Using the loopback interface for multicasting</h1>
<p>This configuration can be used when 'radiod' and all the client applications run on the same host - it will not send multicast packets over to any external network (thus possibly avoiding problems when those networks cannot support multicasting).</p>
<p>The first step is to add the following four lines to 'multicast.c', rebuild and reinstall 'ka9q-radio': </p><div class="fragment"><div class="line">diff --git a/multicast.c b/multicast.c</div>
<div class="line">index 1c451b6..a1f3667 100644</div>
<div class="line">--- a/multicast.c</div>
<div class="line">+++ b/multicast.c</div>
<div class="line">@@ -717,6 +717,10 @@ static int ipv4_join_group(int const fd,void const * const sock,char const * con</div>
<div class="line">     mreqn.imr_ifindex = 0;</div>
<div class="line">   else</div>
<div class="line">     mreqn.imr_ifindex = if_nametoindex(iface);</div>
<div class="line">+  if(setsockopt(fd,IPPROTO_IP,IP_MULTICAST_IF,&amp;mreqn,sizeof(mreqn)) != 0){</div>
<div class="line">+    perror(&quot;multicast v4 set interface&quot;);</div>
<div class="line">+    return -1;</div>
<div class="line">+  }</div>
<div class="line">   if(setsockopt(fd,IPPROTO_IP,IP_ADD_MEMBERSHIP,&amp;mreqn,sizeof(mreqn)) != 0){</div>
<div class="line">     perror(&quot;multicast v4 join&quot;);</div>
<div class="line">     return -1;</div>
</div><!-- fragment --><p> A possible reason for having to call setsockopt(IP_MULTICAST_IF) is the use of the 'connect()' function, as explained here: <a href="https://stackoverflow.com/questions/31791958/why-does-a-udp-connect-call-ignore-a-loopback-multicast-route-but-a-sendto-witho">https://stackoverflow.com/questions/31791958/why-does-a-udp-connect-call-ignore-a-loopback-multicast-route-but-a-sendto-witho</a></p>
<p>The next step is to add the line 'iface = lo' in the [global] section in the radiod configuration file being run (and restart the corresponding radiod service); for instance: </p><div class="fragment"><div class="line">[global]</div>
<div class="line">samprate = 24000</div>
<div class="line">status = nws.local</div>
<div class="line">hardware = sdrplay</div>
<div class="line">#verbose = 1</div>
<div class="line">iface = lo</div>
</div><!-- fragment --><p>Please note that this configuration does not require any additional firewall rules (since all the multicast traffic is over the loopback interface)</p>
<p>I also found that I didn't to add a routing table rule to send multicast over the loopback interface ('ip route add 239.0.0.0/8 dev lo') and I didn't have to explicitly enable multicasting on the loopback interface ('ip link set lo multicast on'); I thought I would mention these two commands in case someone else needs them.</p>
<p>Finally in order to run 'monitor', 'control', 'pcmcat', and other client applications using the loopback interface, you have to append ',lo' to the mDNS name; for instance: </p><div class="fragment"><div class="line">monitor nws-pcm.local,lo</div>
</div><!-- fragment --><p> or: </p><div class="fragment"><div class="line">control -s 162550 nws.local,lo</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
